name: ğŸ¯ ä¿®ä»™ç»Ÿè®¡æ›´æ–°

on:
  repository_dispatch:
    types: [increment_counter]
  workflow_dispatch:  # æ·»åŠ æ‰‹åŠ¨è§¦å‘
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»å‹'
        required: true
        default: 'view'
        type: choice
        options:
        - view
        - like
      test_count:
        description: 'æµ‹è¯•æ•°é‡'
        required: false
        default: '1'
        type: string

permissions:
  contents: write

jobs:
  update-counter:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š æ›´æ–°è®¡æ•°å™¨
        run: |
          # è¯»å–å½“å‰æ•°æ®
          if [ -f data.json ]; then
            echo "ğŸ“– è¯»å–ç°æœ‰çš„data.json"
            views=$(jq -r '.views' data.json)
            likes=$(jq -r '.likes' data.json)
          else
            echo "ğŸ†• åˆ›å»ºæ–°çš„data.json"
            views=0
            likes=0
          fi
          
          # åˆ¤æ–­è§¦å‘æ–¹å¼å¹¶æ›´æ–°è®¡æ•°
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹åŠ¨è§¦å‘æµ‹è¯•
            TEST_TYPE="${{ github.event.inputs.test_type }}"
            TEST_COUNT="${{ github.event.inputs.test_count }}"
            echo "ğŸ§ª æ‰‹åŠ¨æµ‹è¯•: ç±»å‹=$TEST_TYPE, æ•°é‡=$TEST_COUNT"
            
            if [ "$TEST_TYPE" = "view" ]; then
              views=$((views + TEST_COUNT))
              echo "ğŸ‘ï¸ è®¿é—®é‡å¢åŠ  $TEST_COUNT: $views"
            elif [ "$TEST_TYPE" = "like" ]; then
              likes=$((likes + TEST_COUNT))
              echo "ğŸ‘ ç‚¹èµæ•°å¢åŠ  $TEST_COUNT: $likes"
            fi
          else
            # æ­£å¸¸APIè§¦å‘
            EVENT_TYPE="${{ github.event.client_payload.type }}"
            echo "ğŸ“ äº‹ä»¶ç±»å‹: $EVENT_TYPE"
            
            if [ "$EVENT_TYPE" = "view" ]; then
              views=$((views + 1))
              echo "ğŸ‘ï¸ è®¿é—®é‡å¢åŠ åˆ°: $views"
            elif [ "$EVENT_TYPE" = "like" ]; then
              likes=$((likes + 1))
              echo "ğŸ‘ ç‚¹èµæ•°å¢åŠ åˆ°: $likes"
            fi
          fi
          
          # æ›´æ–°æ•°æ®æ–‡ä»¶
          echo "ğŸ’¾ å†™å…¥æ›´æ–°åçš„æ•°æ®..."
          echo "{
            \"views\": $views,
            \"likes\": $likes,
            \"last_updated\": \"$(date -Iseconds)\",
            \"last_action\": \"${{ github.event_name }}\",
            \"triggered_by\": \"${{ github.actor }}\"
          }" > data.json
          
          echo "âœ… æ›´æ–°å®Œæˆ:"
          cat data.json

      - name: ğŸ“¤ æäº¤æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data.json
          git commit -m "ğŸ“ˆ ç»Ÿè®¡æ›´æ–°: ${{ github.event_name }} [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ‰ å®Œæˆé€šçŸ¥
        run: |
          echo "âœ… ç»Ÿè®¡æ›´æ–°å®Œæˆï¼"
          echo "ğŸ“Š æœ€æ–°æ•°æ®:"
          cat data.json
          echo "ğŸ•’ æ›´æ–°æ—¶é—´: $(date)"
