name: Update Stats Data
on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èä¸»è¦ä½¿ç”¨æ–¹å¼ï¼‰
  workflow_dispatch:
  # å®šæ—¶åŒæ­¥ï¼ˆå¯é€‰ï¼Œæ¯2å°æ—¶ä¸€æ¬¡ï¼‰
  schedule:
    - cron: '*/2 * * * *'

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create data directory if not exists
        run: mkdir -p data

      - name: Initialize or update data.json
        run: |
          # å¦‚æœdata.jsonä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆå§‹æ–‡ä»¶
          if [ ! -f "data.json" ]; then
            echo "åˆ›å»ºåˆå§‹data.jsonæ–‡ä»¶"
            cat > data.json << EOF
          {
            "visits": 1,
            "likes": 0,
            "updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "status": "active"
          }
          EOF
          fi

          # è¯»å–å½“å‰æ•°æ®
          CURRENT_VISITS=$(jq -r '.visits' data.json)
          CURRENT_LIKES=$(jq -r '.likes' data.json)
          
          echo "å½“å‰æ•°æ®: visits=$CURRENT_VISITS, likes=$CURRENT_LIKES"

          # ç®€å•çš„æ•°æ®æ›´æ–°é€»è¾‘ï¼ˆè¿™é‡Œå¯ä»¥è‡ªå®šä¹‰ï¼‰
          # ç¤ºä¾‹ï¼šæ¯æ¬¡è¿è¡Œè®¿é—®é‡+1ï¼Œç‚¹èµæ•°éšæœºå¢åŠ 0-2
          NEW_VISITS=$((CURRENT_VISITS + 1))
          RANDOM_LIKES=$((RANDOM % 3))  # 0, 1, æˆ– 2
          NEW_LIKES=$((CURRENT_LIKES + RANDOM_LIKES))
          
          # æ›´æ–°æ•°æ®æ–‡ä»¶
          jq --argjson visits "$NEW_VISITS" \
             --argjson likes "$NEW_LIKES" \
             --arg updated "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
             '.visits = $visits | .likes = $likes | .updated = $updated' \
             data.json > temp.json && mv temp.json data.json
          
          echo "æ›´æ–°åæ•°æ®: visits=$NEW_VISITS, likes=$NEW_LIKES"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ“Š æ›´æ–°ç»Ÿè®¡æ•°æ®: +1è®¿é—®, +ç‚¹èµ [skip ci]"
          git push
