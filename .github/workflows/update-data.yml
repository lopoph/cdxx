name: Update Stats Data
on:
  # æ–¹å¼1: å®šæ—¶è§¦å‘ï¼Œæ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆç”¨äºŽæ›´æ–°è®¿é—®é‡ç­‰ï¼‰
  schedule:
    - cron: '*/5 * * * *'
  # æ–¹å¼2: æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•ï¼‰
  workflow_dispatch:
  # æ–¹å¼3: å½“æœ‰æ–°çš„Issueè¢«åˆ›å»ºæ—¶è§¦å‘ï¼ˆç”¨äºŽå¤„ç†ç‚¹èµžç­‰ç”¨æˆ·äº¤äº’ï¼‰
  issues:
    types: [opened]

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update data.json
        run: |
          # 1. ç¡®ä¿data.jsonå­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º
          if [ ! -f "data.json" ]; then
            echo '{"visits": 0, "likes": 0, "updated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}' > data.json
          fi

          # 2. è¯»å–å½“å‰æ•°æ®
          CURRENT_VISITS=$(jq -r '.visits' data.json)
          CURRENT_LIKES=$(jq -r '.likes' data.json)
          
          # 3. åˆ¤æ–­è§¦å‘ç±»åž‹å¹¶æ›´æ–°æ•°æ®
          # å¦‚æžœæ˜¯å› æ–°çš„Issueè§¦å‘ï¼Œä¸”Issueæ ‡é¢˜åŒ…å«ç‰¹å®šå…³é”®è¯ï¼ˆå¦‚â€œ[LIKE]â€ï¼‰ï¼Œåˆ™å¢žåŠ ç‚¹èµžæ•°
          if [[ "${{ github.event_name }}" == "issues" && "${{ github.event.action }}" == "opened" ]]; then
            if echo "${{ github.event.issue.title }}" | grep -q "\[LIKE\]"; then
              NEW_LIKES=$((CURRENT_LIKES + 1))
              jq --argjson likes "$NEW_LIKES" '.likes = $likes' data.json > temp.json && mv temp.json data.json
              echo "ðŸ‘ ç‚¹èµžæ•°å·²æ›´æ–°ä¸º: $NEW_LIKES"
            fi
          else
            # å¦åˆ™ï¼ˆå®šæ—¶æˆ–æ‰‹åŠ¨è§¦å‘ï¼‰ï¼Œä¸»è¦æ›´æ–°è®¿é—®é‡ï¼Œå¯åœ¨è¿™é‡ŒåŠ å…¥å…¶ä»–é€»è¾‘
            NEW_VISITS=$((CURRENT_VISITS + 1))
            jq --argjson visits "$NEW_VISITS" '.visits = $visits' data.json > temp.json && mv temp.json data.json
            echo "ðŸ‘ï¸ è®¿é—®é‡å·²æ›´æ–°ä¸º: $NEW_VISITS"
          fi

          # 4. æ›´æ–°æœ€åŽä¿®æ”¹æ—¶é—´
          jq --arg updated "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" '.updated = $updated' data.json > temp.json && mv temp.json data.json

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data.json
          git commit -m "ðŸ”„ Auto-update stats data [skip ci]" || exit 0
          git push
